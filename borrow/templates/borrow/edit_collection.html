{% extends "base.html" %}

{% block title %}Edit Collection | HooBorrow{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Edit Collection: {{ collection.title }}</h2>
  </div>
  
  <form method="post" id="collection-form">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
    
    <div class="mb-3">
      <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
      {{ form.title }}
      {% if form.title.errors %}
        <div class="text-danger">{{ form.title.errors }}</div>
      {% endif %}
    </div>
    
    <div class="mb-3">
      <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
      {{ form.description }}
      {% if form.description.errors %}
        <div class="text-danger">{{ form.description.errors }}</div>
      {% endif %}
    </div>
    
    <!-- Items Selection -->
    <div id="items-container">
      <div class="mb-3">
        <h5>Current Items</h5>
        <div class="list-group">
          {% for item in collection.items_list %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ item.name }}</strong>
                <div class="input-group" style="max-width: 200px;">
                  <input type="text" disabled
                         value="{{ item.quantity }}" 
                         class="form-control"
                         aria-label="Item quantity">
                  <span class="input-group-text">of {{ item.quantity }}</span>
                </div>
              </div>
              <button type="button" class="btn-close remove-item" aria-label="Remove" 
                      data-item-id="{{ item.id }}"></button>
              <input type="hidden" name="remove_item_{{ item.id }}" id="remove_item_{{ item.id }}" value="0">
            </div>
          {% endfor %}
        </div>
      </div>
      
      <div class="mb-3">
        <h5>Add Items</h5>
        <button type="button" id="browse-items-btn" class="btn btn-outline-primary">Browse</button>
        <div id="selected-items" class="list-group mt-2">
          <!-- Selected items will appear here -->
        </div>
      </div>
    </div>
    
    <div class="mb-3">
      <strong>Visibility:</strong>
      {% if collection.is_collection_private %}
        <span class="badge bg-warning text-dark">Private</span>
      {% else %}
        <span class="badge bg-success">Public</span>
      {% endif %}
    </div>
    
    <!-- Users Selection (for private collections) -->
    {% if collection.is_collection_private and form.allowed_users %}
      <div class="mb-3" id="allowed-users-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label mb-0">Allowed Users</label>
          <button type="button" id="browse-users-btn" class="btn btn-primary">Browse</button>
        </div>
        
        <div id="selected-users" class="list-group mb-2" style="max-width: 50%;">
          <!-- Selected users will appear here -->
        </div>
        <!-- Hidden input to store the selected user IDs -->
        <div id="users-container" style="display: none;">
          {{ form.allowed_users }}
        </div>
      </div>
    {% endif %}
    
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a href="{% url 'borrow:manage_collections' %}" class="btn btn-secondary">Cancel</a>
  </form>

  <!-- Item Search Modal -->
  <div class="modal fade" id="itemSearchModal" tabindex="-1" aria-labelledby="itemSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemSearchModalLabel">Browse Items</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="modal-item-search" class="form-control mb-3" placeholder="Type to search...">
          <div id="item-search-results" class="list-group">
            <!-- Search results will appear here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Search Modal -->
  <div class="modal fade" id="userSearchModal" tabindex="-1" aria-labelledby="userSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userSearchModalLabel">Browse Users</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="modal-user-search" class="form-control mb-3" placeholder="Type to search...">
          <div id="user-search-results" class="list-group">
            <!-- Search results will appear here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Hide the default form widgets
      document.querySelectorAll('#items-container .form-check').forEach(el => {
        el.style.display = 'none';
      });
      
      if (document.getElementById('users-container')) {
        document.querySelectorAll('#users-container .form-check').forEach(el => {
          el.style.display = 'none';
        });
      }
      
      const modalItemSearch = document.getElementById('modal-item-search');
      const selectedItemsContainer = document.getElementById('selected-items');
      const itemsContainer = document.getElementById('items-container');
      
      let modalUserSearch, selectedUsersContainer, usersContainer;
      
      if (document.getElementById('allowed-users-section')) {
        modalUserSearch = document.getElementById('modal-user-search');
        selectedUsersContainer = document.getElementById('selected-users');
        usersContainer = document.getElementById('users-container');
      }
      
      // Item search and selection
      const itemModal = new bootstrap.Modal(document.getElementById('itemSearchModal'));
      document.getElementById('browse-items-btn').addEventListener('click', function() {
        modalItemSearch.value = '';
        searchItems(''); // Show all items initially
        itemModal.show();
      });
      
      modalItemSearch.addEventListener('input', function() {
        searchItems(this.value);
      });
      
      function searchItems(query) {
        // Simulate a search through the existing checkboxes
        const results = document.getElementById('item-search-results');
        results.innerHTML = '';
        
        // Fetch items via AJAX
        fetch(`/borrow/api/items/search/?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(items => {
            items.forEach(item => {
              // Skip items that have no available quantity
              if (item.quantity <= 0) return;
              
              const resultItem = document.createElement('a');
              resultItem.href = '#';
              resultItem.className = 'list-group-item list-group-item-action';
              resultItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${item.name}</strong>
                    <div><small>Available: ${item.quantity}</small></div>
                  </div>
                  <div class="input-group" style="max-width: 150px;">
                    <input type="number" class="form-control item-quantity-input" 
                           min="1" max="${item.quantity}" value="1">
                    <button class="btn btn-primary add-item-btn" type="button" 
                            data-item-id="${item.id}" data-item-name="${item.name}">Add</button>
                  </div>
                </div>
              `;
              
              // Add click handler to the add button
              resultItem.querySelector('.add-item-btn').addEventListener('click', function(e) {
                e.preventDefault();
                const quantity = parseInt(resultItem.querySelector('.item-quantity-input').value);
                if (quantity < 1 || quantity > item.quantity) {
                  alert(`Please enter a valid quantity between 1 and ${item.quantity}`);
                  return;
                }
                
                addItemToCollection(item.id, item.name, quantity);
                itemModal.hide();
              });
              
              results.appendChild(resultItem);
            });
            
            if (results.children.length === 0) {
              results.innerHTML = '<div class="list-group-item text-muted">No items found</div>';
            }
          });
      }
      
      function addItemToCollection(itemId, itemName, quantity) {
        // Create hidden input for the server
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = `new_item_${itemId}`;
        input.value = quantity;
        document.getElementById('collection-form').appendChild(input);
        
        // Add visual element
        const itemElement = document.createElement('div');
        itemElement.className = 'list-group-item d-flex justify-content-between align-items-center';
        itemElement.innerHTML = `
          <div>
            <strong>${itemName}</strong>
            <div><small>Quantity: ${quantity}</small></div>
          </div>
          <button type="button" class="btn-close remove-new-item" aria-label="Remove" 
                  data-item-id="${itemId}"></button>
        `;
        
        itemElement.querySelector('.remove-new-item').addEventListener('click', function() {
          document.querySelector(`input[name="new_item_${itemId}"]`).remove();
          itemElement.remove();
        });
        
        document.getElementById('selected-items').appendChild(itemElement);
      }
      
      // User search and selection (only if in a private collection)
      if (document.getElementById('allowed-users-section')) {
        const userModal = new bootstrap.Modal(document.getElementById('userSearchModal'));
        document.getElementById('browse-users-btn').addEventListener('click', function() {
          modalUserSearch.value = '';
          searchUsers(''); // Show all users initially
          userModal.show();
        });
        
        modalUserSearch.addEventListener('input', function() {
          searchUsers(this.value);
        });
        
        function searchUsers(query) {
          // Simulate a search through the existing checkboxes
          const results = document.getElementById('user-search-results');
          results.innerHTML = '';
          
          const userCheckboxes = usersContainer.querySelectorAll('input[type="checkbox"]');
          userCheckboxes.forEach(checkbox => {
            const label = usersContainer.querySelector(`label[for="${checkbox.id}"]`);
            if (label && (query === '' || label.textContent.toLowerCase().includes(query.toLowerCase()))) {
              const resultItem = document.createElement('a');
              resultItem.href = '#';
              resultItem.className = 'list-group-item list-group-item-action';
              resultItem.textContent = label.textContent;
              resultItem.dataset.userId = checkbox.value;
              resultItem.dataset.userName = label.textContent;
              
              // Check if already selected and add visual indicator
              if (checkbox.checked) {
                resultItem.classList.add('active');
                resultItem.innerHTML += '<span class="float-end">✓</span>';
              }
              
              // Add click event to select this user
              resultItem.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Toggle selection
                const isSelected = document.querySelector(`#selected-users [data-user-id="${this.dataset.userId}"]`);
                if (isSelected) {
                  // If already selected, remove it
                  const checkbox = document.querySelector(`#users-container input[value="${this.dataset.userId}"]`);
                  if (checkbox) {
                    checkbox.checked = false;
                  }
                  isSelected.remove();
                  this.classList.remove('active');
                  this.querySelector('.float-end')?.remove();
                } else {
                  // Otherwise add it
                  selectUser(this.dataset.userId, this.dataset.userName);
                  this.classList.add('active');
                  if (!this.querySelector('.float-end')) {
                    this.innerHTML += '<span class="float-end">✓</span>';
                  }
                }
              });
              
              results.appendChild(resultItem);
            }
          });
          
          if (results.children.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'list-group-item text-muted';
            noResults.textContent = 'No users found';
            results.appendChild(noResults);
          }
        }
        
        function selectUser(userId, userName) {
          // Check if user is already selected
          if (document.querySelector(`#selected-users [data-user-id="${userId}"]`)) {
            return;
          }
          
          // Check the corresponding checkbox
          const checkbox = document.querySelector(`#users-container input[value="${userId}"]`);
          if (checkbox) {
            checkbox.checked = true;
          }
          
          // Add to the visual selection
          const userElement = document.createElement('div');
          userElement.className = 'list-group-item d-flex justify-content-between align-items-center';
          userElement.dataset.userId = userId;
          
          userElement.innerHTML = `
            <span>${userName}</span>
            <button type="button" class="btn-close remove-user" aria-label="Remove"></button>
          `;
          
          userElement.querySelector('.remove-user').addEventListener('click', function() {
            // Uncheck the corresponding checkbox
            const checkbox = document.querySelector(`#users-container input[value="${userId}"]`);
            if (checkbox) {
              checkbox.checked = false;
            }
            
            // Update modal user if it's visible
            const modalUser = document.querySelector(`#user-search-results [data-user-id="${userId}"]`);
            if (modalUser) {
              modalUser.classList.remove('active');
              modalUser.querySelector('.float-end')?.remove();
            }
            
            // Remove from visual selection
            userElement.remove();
          });
          
          selectedUsersContainer.appendChild(userElement);
        }
        
        // Pre-select users that are already selected in the form
        document.querySelectorAll('#users-container input[type="checkbox"]:checked').forEach(checkbox => {
          const label = document.querySelector(`label[for="${checkbox.id}"]`);
          if (label) {
            selectUser(checkbox.value, label.textContent);
          }
        });
      }
      
      // Pre-select items that are already selected in the form
      document.querySelectorAll('#items-container input[type="checkbox"]:checked').forEach(checkbox => {
        const label = document.querySelector(`label[for="${checkbox.id}"]`);
        if (label) {
          selectItem(checkbox.value, label.textContent);
        }
      });
    });
    
    document.querySelectorAll('.remove-item').forEach(button => {
      button.addEventListener('click', function() {
        const itemId = this.getAttribute('data-item-id');
        const hiddenInput = document.getElementById(`remove_item_${itemId}`);
        hiddenInput.value = "1";
        this.closest('.list-group-item').style.display = 'none';
      });
    });
  </script>
</div>
{% endblock %}
