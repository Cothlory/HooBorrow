{% extends "base.html" %}
{% block title %}Edit Collection | HooBorrow{% endblock %}
{% block content %}
<div class="container mt-4">

  <style>
    /* red outline on rows marked for removal */
    .list-group-item.is-removing {
      border: 2px solid #dc3545 !important;
    }
  </style>

  <form method="post" id="collection-form">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
    
    <div class="mb-3">
      <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
      {{ form.title }}
      {% if form.title.errors %}
        <div class="text-danger">{{ form.title.errors }}</div>
      {% endif %}
    </div>
    
    <div class="mb-3">
      <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
      {{ form.description }}
      {% if form.description.errors %}
        <div class="text-danger">{{ form.description.errors }}</div>
      {% endif %}
    </div>
    
    <!-- Current Items -->
    <div id="items-container">
      <div class="mb-3">
        <h5>Current Items</h5>
        <div class="list-group">
          {% if collection.is_collection_private %}
            <!-- Display items for private collections -->
            {% for item in collection.collection_items.all %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ item.name }}</strong>
                  <div class="input-group" style="max-width: 200px;">
                    <input type="text" disabled
                           value="{{ item.quantity }}"
                           class="form-control"
                           aria-label="Item quantity">
                    <span class="input-group-text">in collection</span>
                  </div>
                </div>
                <button type="button"
                        class="btn btn-sm btn-outline-danger remove-item"
                        data-item-id="{{ item.id }}">
                  Remove
                </button>
                <input type="hidden"
                       name="remove_item_{{ item.id }}"
                       id="remove_item_{{ item.id }}"
                       value="0">
              </div>
            {% empty %}
              <div class="list-group-item text-muted">No items in this collection yet.</div>
            {% endfor %}
          {% else %}
            <!-- Display item allocations for public collections -->
            {% for allocation in collection.item_allocations.all %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ allocation.item.name }}</strong>
                  <div>
                    <small>Available quantity: {{ allocation.item.quantity }}</small>
                  </div>
                </div>
                <button type="button"
                        class="btn btn-sm btn-outline-danger remove-item"
                        data-item-id="{{ allocation.item.id }}">
                  Remove
                </button>
                <input type="hidden"
                       name="remove_item_{{ allocation.item.id }}"
                       id="remove_item_{{ allocation.item.id }}"
                       value="0">
              </div>
            {% empty %}
              <div class="list-group-item text-muted">No items in this collection yet.</div>
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Add Items -->
    <div class="mb-3">
      <h5>Add Items</h5>
      <button type="button" id="browse-items-btn" class="btn btn-outline-primary">Browse</button>
      <div id="selected-items" class="list-group mt-2">
        <!-- Selected items will appear here -->
      </div>
    </div>

    <div class="mb-3">
      <strong>Visibility:</strong>
      {% if collection.is_collection_private %}
        <span class="badge bg-warning text-dark">Private</span>
      {% else %}
        <span class="badge bg-success">Public</span>
      {% endif %}
    </div>
    
    <!-- Users Selection (for private collections) -->
    {% if collection.is_collection_private and form.allowed_users %}
      <div class="mb-3" id="allowed-users-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label mb-0">Allowed Users</label>
          <button type="button" id="browse-users-btn" class="btn btn-outline-primary">Browse Users</button>
        </div>
        
        <div id="selected-users" class="list-group mb-2" style="max-width: 50%;">
          <!-- Selected users will appear here -->
        </div>
        <!-- Hidden input to store the selected user IDs -->
        <div id="users-container" style="display: none;">
          {{ form.allowed_users }}
        </div>
      </div>
    {% endif %}
    
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a href="{% url 'borrow:manage_collections' %}" class="btn btn-secondary">Cancel</a>
  </form>

  <script>
    // JavaScript code here (from step 4)
    document.addEventListener('DOMContentLoaded', function() {
      // Set up item removal handlers
      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.dataset.itemId;
          const hidden = document.getElementById(`remove_item_${id}`);
          const row = this.closest('.list-group-item');

          if (hidden.value === "0") {
            // mark for removal
            hidden.value = "1";
            row.classList.add('is-removing');
            this.textContent = 'Cancel';
            this.classList.remove('btn-outline-danger');
            this.classList.add('btn-outline-secondary');
          } else {
            // undo removal
            hidden.value = "0";
            row.classList.remove('is-removing');
            this.textContent = 'Remove';
            this.classList.add('btn-outline-danger');
            this.classList.remove('btn-outline-secondary');
          }
        });
      });

      // Initialize modals
      const itemModal = new bootstrap.Modal(document.getElementById('itemSearchModal'));
      const modalItemSearch = document.getElementById('modal-item-search');
      const selectedItemsContainer = document.getElementById('selected-items');

      // Show item modal when Browse button is clicked
      document.getElementById('browse-items-btn').addEventListener('click', function() {
        modalItemSearch.value = '';
        searchItems(''); // Show all items initially
        itemModal.show();
      });

      // Handle item search input
      modalItemSearch.addEventListener('input', function() {
        searchItems(this.value);
      });

      // Item search function
      function searchItems(query) {
        const results = document.getElementById('item-search-results');
        results.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        const isPrivateCollection = {{ collection.is_collection_private|lower }};
        
        // Fetch items via AJAX
        fetch(`/borrow/api/items/search/?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(items => {
            results.innerHTML = '';
            
            items.forEach(item => {
              // Skip items that have no available quantity
              if (item.available_quantity <= 0) return;
              
              const resultItem = document.createElement('a');
              resultItem.href = '#';
              resultItem.className = 'list-group-item list-group-item-action';
              
              if (isPrivateCollection) {
                // For private collections: show quantity input
                resultItem.innerHTML = `
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>${item.name}</strong>
                      <div><small>Available: ${item.available_quantity} of ${item.quantity}</small></div>
                    </div>
                    <div class="input-group" style="max-width: 150px;">
                      <input type="number" class="form-control item-quantity-input" 
                             min="1" max="${item.available_quantity}" value="1">
                      <button class="btn btn-primary add-item-btn" type="button" 
                              data-item-id="${item.id}" data-item-name="${item.name}">Add</button>
                    </div>
                  </div>
                `;
                
                // Add click handler for private collection items
                resultItem.querySelector('.add-item-btn').addEventListener('click', function(e) {
                  e.preventDefault();
                  const quantity = parseInt(resultItem.querySelector('.item-quantity-input').value);
                  if (quantity < 1 || quantity > item.available_quantity) {
                    alert(`Please enter a valid quantity between 1 and ${item.available_quantity}`);
                    return;
                  }
                  
                  addItemToCollection(item.id, item.name, quantity);
                  itemModal.hide();
                });
              } else {
                // For public collections: simpler interface with no quantity input
                resultItem.innerHTML = `
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>${item.name}</strong>
                      <div><small>Available: ${item.available_quantity}</small></div>
                    </div>
                    <button class="btn btn-primary add-item-btn" type="button" 
                            data-item-id="${item.id}" data-item-name="${item.name}">Add to Collection</button>
                  </div>
                `;
                
                // Add click handler for public collection items
                resultItem.querySelector('.add-item-btn').addEventListener('click', function(e) {
                  e.preventDefault();
                  // For public collections, we pass a special value (0) to indicate "use original item"
                  addItemToCollection(item.id, item.name, 0);
                  itemModal.hide();
                });
              }
              
              results.appendChild(resultItem);
            });
            
            if (results.children.length === 0) {
              results.innerHTML = '<div class="list-group-item text-muted">No items found</div>';
            }
          })
          .catch(error => {
            results.innerHTML = '<div class="list-group-item text-danger">Error loading items</div>';
            console.error('Error fetching items:', error);
          });
      }
      
      function addItemToCollection(itemId, itemName, quantity) {
        // Create hidden input for the server
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = `new_item_${itemId}`;
        input.value = quantity;
        document.getElementById('collection-form').appendChild(input);
        
        // Add visual element
        const itemElement = document.createElement('div');
        itemElement.className = 'list-group-item d-flex justify-content-between align-items-center';
        
        const isPrivateCollection = {{ collection.is_collection_private|lower }};
        if (isPrivateCollection) {
          itemElement.innerHTML = `
            <div>
              <strong>${itemName}</strong>
              <div><small>Quantity: ${quantity}</small></div>
            </div>
            <button type="button" class="btn-close remove-new-item" aria-label="Remove" 
                    data-item-id="${itemId}"></button>
          `;
        } else {
          itemElement.innerHTML = `
            <div>
              <strong>${itemName}</strong>
              <div><small>Using original item quantity</small></div>
            </div>
            <button type="button" class="btn-close remove-new-item" aria-label="Remove" 
                    data-item-id="${itemId}"></button>
          `;
        }
        
        itemElement.querySelector('.remove-new-item').addEventListener('click', function() {
          document.querySelector(`input[name="new_item_${itemId}"]`).remove();
          itemElement.remove();
        });
        
        selectedItemsContainer.appendChild(itemElement);
      }

      // User browsing - only initialize if the userSearchModal exists
      if (document.getElementById('userSearchModal')) {
        const userModal = new bootstrap.Modal(document.getElementById('userSearchModal'));
        const modalUserSearch = document.getElementById('modal-user-search');
        const selectedUsersContainer = document.getElementById('selected-users');

        // Show user modal when Browse button is clicked
        if (document.getElementById('browse-users-btn')) {
          document.getElementById('browse-users-btn').addEventListener('click', function() {
            modalUserSearch.value = '';
            searchUsers(''); // Show all users initially
            userModal.show();
          });

          // Handle user search input
          modalUserSearch.addEventListener('input', function() {
            searchUsers(this.value);
          });
        }

        function searchUsers(query) {
          const results = document.getElementById('user-search-results');
          results.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
          
          // Fetch users via AJAX
          fetch(`/borrow/api/users/search/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(users => {
              results.innerHTML = '';
              
              users.forEach(user => {
                const resultItem = document.createElement('a');
                resultItem.href = '#';
                resultItem.className = 'list-group-item list-group-item-action';
                resultItem.dataset.userId = user.id;
                resultItem.dataset.userName = user.name;
                
                // Check if user is already selected in the form
                const checkbox = document.querySelector(`#users-container input[value="${user.id}"]`);
                const isChecked = checkbox && checkbox.checked;
                
                resultItem.innerHTML = `
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>${user.name}</strong>
                      <div><small>${user.email}</small></div>
                    </div>
                    <button class="btn ${isChecked ? 'btn-success' : 'btn-primary'} add-user-btn" type="button">
                      ${isChecked ? 'Added' : 'Add'}
                    </button>
                  </div>
                `;
                
                // Add click handler to the add button
                resultItem.querySelector('.add-user-btn').addEventListener('click', function(e) {
                  e.preventDefault();
                  
                  const checkbox = document.querySelector(`#users-container input[value="${user.id}"]`);
                  
                  if (checkbox) {
                    // Toggle user selection
                    if (checkbox.checked) {
                      // Remove the user
                      checkbox.checked = false;
                      this.textContent = 'Add';
                      this.classList.remove('btn-success');
                      this.classList.add('btn-primary');
                      
                      // Remove from visual display
                      const existingUser = document.querySelector(`#selected-users [data-user-id="${user.id}"]`);
                      if (existingUser) {
                        existingUser.remove();
                      }
                    } else {
                      // Add the user
                      checkbox.checked = true;
                      this.textContent = 'Added';
                      this.classList.remove('btn-primary');
                      this.classList.add('btn-success');
                      
                      // Add to visual display
                      addUserToCollection(user.id, user.name);
                    }
                  }
                });
                
                results.appendChild(resultItem);
              });
              
              if (results.children.length === 0) {
                results.innerHTML = '<div class="list-group-item text-muted">No users found</div>';
              }
            })
            .catch(error => {
              results.innerHTML = '<div class="list-group-item text-danger">Error loading users</div>';
              console.error('Error fetching users:', error);
            });
        }
        
        function addUserToCollection(userId, userName) {
          // Check if user is already in the selected list
          if (document.querySelector(`#selected-users [data-user-id="${userId}"]`)) {
            return;
          }
          
          // Add visual element
          const userElement = document.createElement('div');
          userElement.className = 'list-group-item d-flex justify-content-between align-items-center';
          userElement.dataset.userId = userId;
          
          userElement.innerHTML = `
            <div>
              <strong>${userName}</strong>
            </div>
            <button type="button" class="btn-close remove-user" aria-label="Remove"></button>
          `;
          
          userElement.querySelector('.remove-user').addEventListener('click', function() {
            // Uncheck the corresponding checkbox
            const checkbox = document.querySelector(`#users-container input[value="${userId}"]`);
            if (checkbox) {
              checkbox.checked = false;
            }
            
            // Update modal user button if visible
            const modalBtn = document.querySelector(`#user-search-results [data-user-id="${userId}"] .add-user-btn`);
            if (modalBtn) {
              modalBtn.textContent = 'Add';
              modalBtn.classList.remove('btn-success');
              modalBtn.classList.add('btn-primary');
            }
            
            // Remove from visual selection
            userElement.remove();
          });
          
          selectedUsersContainer.appendChild(userElement);
        }

        // Pre-select users that are already selected in the form
        if (document.getElementById('users-container')) {
          document.querySelectorAll('#users-container input[type="checkbox"]:checked').forEach(checkbox => {
            if (checkbox.checked) {
              const label = document.querySelector(`label[for="${checkbox.id}"]`);
              if (label) {
                addUserToCollection(checkbox.value, label.textContent.trim());
              }
            }
          });
        }
      }
    });
  </script>

  <!-- Item Search Modal -->
  <div class="modal fade" id="itemSearchModal" tabindex="-1" aria-labelledby="itemSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemSearchModalLabel">Browse Items</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="modal-item-search" class="form-control mb-2" placeholder="Search items...">
          <div class="list-group" id="item-search-results"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Search Modal -->
  <div class="modal fade" id="userSearchModal" tabindex="-1" aria-labelledby="userSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userSearchModalLabel">Browse Users</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="modal-user-search" class="form-control mb-2" placeholder="Search users...">
          <div class="list-group" id="user-search-results"></div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
