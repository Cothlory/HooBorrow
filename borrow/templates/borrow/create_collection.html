{% extends 'base.html' %}

{% block title %}Create Collection | HooBorrow{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Create New Collection</h2>
  </div>
  
  <form method="post" id="collection-form">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
    
    <div class="mb-3">
      <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
      {{ form.title }}
      {% if form.title.errors %}
        <div class="text-danger">{{ form.title.errors }}</div>
      {% endif %}
    </div>
    
    <div class="mb-3">
      <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
      {{ form.description }}
      {% if form.description.errors %}
        <div class="text-danger">{{ form.description.errors }}</div>
      {% endif %}
    </div>
    
    {% if is_librarian %}
      <div class="mb-3 form-check">
        {{ form.is_collection_private }}
        <label for="{{ form.is_collection_private.id_for_label }}" class="form-check-label">{{ form.is_collection_private.label }}</label>
      </div>
    {% endif %}
    
    <!-- Users Selection (for private collections) -->
    <div class="mb-3" id="allowed-users-section" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label mb-0">Allowed Users</label>
        <button type="button" id="browse-users-btn" class="btn btn-outline-primary">Browse Users</button>
      </div>
      
      <div id="selected-users" class="list-group mb-2" style="max-width: 50%;">
        <!-- Selected users will appear here -->
      </div>
      <!-- Hidden input to store the selected user IDs -->
      <div id="users-container" style="display: none;">
        {{ form.allowed_users }}
      </div>
    </div>
    
    <div class="alert alert-info">
      After creating the collection, you will be able to add items to it.
    </div>
    
    <button type="submit" class="btn btn-primary">Create Collection</button>
    <a href="{% url 'borrow:manage_collections' %}" class="btn btn-secondary">Cancel</a>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Hide the default form widgets
      if (document.getElementById('users-container')) {
        document.querySelectorAll('#users-container .form-check').forEach(el => {
          el.style.display = 'none';
        });
      }
      
      // User search and selection (only if in a private collection)
      if (document.getElementById('allowed-users-section')) {
        const userModal = new bootstrap.Modal(document.getElementById('userSearchModal'));
        const modalUserSearch = document.getElementById('modal-user-search');
        const selectedUsersContainer = document.getElementById('selected-users');
        
        // Show user modal when Browse Users button is clicked
        document.getElementById('browse-users-btn').addEventListener('click', function() {
          modalUserSearch.value = '';
          searchUsers(''); // Show all users initially
          userModal.show();
        });
        
        modalUserSearch.addEventListener('input', function() {
          searchUsers(this.value);
        });
        
        function searchUsers(query) {
          const results = document.getElementById('user-search-results');
          results.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
          
          // Fetch users via AJAX
          fetch(`/borrow/api/users/search/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(users => {
              results.innerHTML = '';
              
              users.forEach(user => {
                const resultItem = document.createElement('a');
                resultItem.href = '#';
                resultItem.className = 'list-group-item list-group-item-action';
                resultItem.dataset.userId = user.id;
                resultItem.dataset.userName = user.name;
                
                // Check if user is already selected in the form
                const checkbox = document.querySelector(`#users-container input[value="${user.id}"]`);
                const isChecked = checkbox && checkbox.checked;
                
                resultItem.innerHTML = `
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>${user.name}</strong>
                      <div><small>${user.email}</small></div>
                    </div>
                    <button class="btn ${isChecked ? 'btn-success' : 'btn-primary'} add-user-btn" type="button">
                      ${isChecked ? 'Added' : 'Add'}
                    </button>
                  </div>
                `;
                
                // Add click handler to add user button
                resultItem.querySelector('.add-user-btn').addEventListener('click', function(e) {
                  e.preventDefault();
                  
                  const checkbox = document.querySelector(`#users-container input[value="${user.id}"]`);
                  
                  if (checkbox) {
                    if (checkbox.checked) {
                      // Remove the user
                      checkbox.checked = false;
                      this.textContent = 'Add';
                      this.classList.remove('btn-success');
                      this.classList.add('btn-primary');
                      
                      const existingUser = document.querySelector(`#selected-users [data-user-id="${user.id}"]`);
                      if (existingUser) {
                        existingUser.remove();
                      }
                    } else {
                      // Add the user
                      checkbox.checked = true;
                      this.textContent = 'Added';
                      this.classList.remove('btn-primary');
                      this.classList.add('btn-success');
                      
                      addUserToCollection(user.id, user.name);
                    }
                  }
                });
                
                results.appendChild(resultItem);
              });
              
              if (results.children.length === 0) {
                results.innerHTML = '<div class="list-group-item text-muted">No users found</div>';
              }
            })
            .catch(error => {
              results.innerHTML = '<div class="list-group-item text-danger">Error loading users</div>';
              console.error('Error fetching users:', error);
            });
        }
        
        function addUserToCollection(userId, userName) {
          // Check if user is already in the selected list
          if (document.querySelector(`#selected-users [data-user-id="${userId}"]`)) {
            return;
          }
          
          // Add visual element
          const userElement = document.createElement('div');
          userElement.className = 'list-group-item d-flex justify-content-between align-items-center';
          userElement.dataset.userId = userId;
          
          userElement.innerHTML = `
            <div>
              <strong>${userName}</strong>
            </div>
            <button type="button" class="btn-close remove-user" aria-label="Remove"></button>
          `;
          
          userElement.querySelector('.remove-user').addEventListener('click', function() {
            // Uncheck the corresponding checkbox
            const checkbox = document.querySelector(`#users-container input[value="${userId}"]`);
            if (checkbox) {
              checkbox.checked = false;
            }
            
            // Update modal user button if visible
            const modalBtn = document.querySelector(`#user-search-results [data-user-id="${userId}"] .add-user-btn`);
            if (modalBtn) {
              modalBtn.textContent = 'Add';
              modalBtn.classList.remove('btn-success');
              modalBtn.classList.add('btn-primary');
            }
            
            // Remove from visual selection
            userElement.remove();
          });
          
          selectedUsersContainer.appendChild(userElement);
        }
      }
      
      // Handle private collection toggle
      const isPrivateCheckbox = document.getElementById('id_is_collection_private');
      const allowedUsersSection = document.getElementById('allowed-users-section');
      
      function toggleAllowedUsers() {
        if (isPrivateCheckbox && isPrivateCheckbox.checked) {
          allowedUsersSection.style.display = 'block';
        } else if (isPrivateCheckbox) {
          allowedUsersSection.style.display = 'none';
          // Uncheck all user checkboxes
          document.querySelectorAll('#users-container input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
          });
          // Clear visual selection
          if (document.getElementById('selected-users')) {
            document.getElementById('selected-users').innerHTML = '';
          }
        }
      }
      
      if (isPrivateCheckbox) {
        toggleAllowedUsers(); // Initial state
        isPrivateCheckbox.addEventListener('change', toggleAllowedUsers);
      }
    });
  </script>

  <!-- User Search Modal -->
  <div class="modal fade" id="userSearchModal" tabindex="-1" aria-labelledby="userSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userSearchModalLabel">Browse Users</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="modal-user-search" class="form-control mb-2" placeholder="Search users...">
          <div class="list-group" id="user-search-results"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
